<!--
 Author: Edgar Butwilowski
 Copyright (c) Vermessungsamt Winterthur. All rights reserved.
-->
<mat-card class="mat-mdc-elevation-specific mat-elevation-z3">
    <mat-card-header style="margin: 0.5em;">
        <div style="width: 80%; margin-right: 1em;">
            <mat-card-title>{{ playdevice.properties.type.description.slice(0, 14) }}<span
                    *ngIf="playdevice.properties.type.description.length > 14">...</span>
            </mat-card-title>
            <mat-card-subtitle>{{ playdevice.properties.type.name.slice(0, 20) }}<span
                    *ngIf="playdevice.properties.type.name.length > 20">...</span>
            </mat-card-subtitle>
        </div>
        <div>
            <mat-chip-list>
                <mat-chip *ngIf="playdevice.properties.cannotBeChecked" class="chip-cannotbedone">inaktiv</mat-chip>
                <mat-chip *ngIf="playdevice.properties.notToBeChecked" class="chip-nottobedone">inaktiv</mat-chip>
                <mat-chip *ngIf="!playdevice.properties.cannotBeChecked && !playdevice.properties.notToBeChecked
                                    && playdevice.properties.hasChecks && !playdevice.properties.hasOpenChecks"
                    (click)="switchAllCheckBoxes(false)" class="chip-done">erledigt</mat-chip>
                <mat-chip *ngIf="!playdevice.properties.cannotBeChecked && !playdevice.properties.notToBeChecked
                                    && playdevice.properties.hasChecks && playdevice.properties.hasOpenChecks"
                    (click)="switchAllCheckBoxes(true)" class="chip-pending">pendent</mat-chip>
                <mat-chip *ngIf="cardType == 'inspection' && !playdevice.properties.hasChecks" class="chip-no-control">
                    keine&nbsp;Kontrollen
                </mat-chip>
            </mat-chip-list>
        </div>
    </mat-card-header>
    <mat-tab-group>
        <mat-tab label="Foto">
            <div>
                <img title="Foto des Spielgeräts"
                    style="display: block; width: 95%; margin-left: auto; margin-right: auto; margin-top: 0.5em;"
                    [src]="environment.apiUrl + '/playdevice/' + playdevice.properties.fid + '/Picture?dryRun=false&t=' + imageTimestamp">
                <div *ngIf="cardType == 'overview' && !playdevice.properties.notToBeChecked">
                    <span style="font-size: 70%;margin-left:1em;">Foto ersetzen...</span>
                    <input type="file" accept="image/png" (change)="exchangePhoto(playdevice.properties.fid, $event)"
                        style="padding: 1em;">
                </div>
            </div>
        </mat-tab>
        <mat-tab label="Karte">
            <div>
                <a title="Link auf Kartenausschnitt Spielgerät" target="_blank"
                    href="https://stadtplan.winterthur.ch/mini?gbapp=portal&topic=Spielplatzkarte&infoactive=1&maponly=1&onlymap=1&scale=200&x={{ playdevice.geometry.coordinates[0] }}&y={{ playdevice.geometry.coordinates[1] }}&back=Hintergrundkarte_LK_AV_Situationsplan">
                    <img title="Kartenausschnitt des Spielgeräts"
                        style="display: block; width: 95%; margin-left: auto; margin-right: auto; margin-top: 0.5em;"
                        src="http://stadtplan.winterthur.ch/wms/Spielplatzkarte?LAYERS=AV_UEP_Landeskarten,Spielplatz&VERSION=1.1.1&DPI=96&TRANSPARENT=TRUE&FORMAT=image%2Fpng&SERVICE=WMS&REQUEST=GetMap&STYLES=&SRS=EPSG%3A2056&BBOX={{(playdevice.geometry.coordinates[0] - 10)}},{{(playdevice.geometry.coordinates[1] - 5)}},{{(playdevice.geometry.coordinates[0] + 10)}},{{(playdevice.geometry.coordinates[1] + 5)}}&WIDTH=800&HEIGHT=400">
                </a>
            </div>
        </mat-tab>
    </mat-tab-group>
    <mat-card-content style="margin: 0.5em;margin-top: 3em;">
        <p *ngIf="cardType != 'defect'" style="margin-top: 2em;margin-bottom: 2em;">
            <b>Norm (Jahrgang)</b>:
            <span *ngIf="playdevice.properties.type.standard.length !== 0"><i>{{
                    playdevice.properties.type.standard }}</i></span>
            <span *ngIf="playdevice.properties.type.standard.length === 0"><i>Nicht angegeben</i></span>
        </p>
        <p *ngIf="cardType != 'defect'" style="margin-bottom: 2em;">
            <b>Lieferant</b>:
            <span *ngIf="playdevice.properties.supplier && playdevice.properties.supplier.length !== 0">
                <i>{{ playdevice.properties.supplier }}</i>
            </span>
            <span *ngIf="!playdevice.properties.supplier || playdevice.properties.supplier.length === 0">
                <i>unbekannt</i>
            </span>
        </p>
        <p *ngIf="cardType != 'defect'" style="margin-bottom: 2em;">
            <b>Erstellungsjahr</b>:
            <span *ngIf="hasConstructionDate()">
                <i>{{playdevice.properties.constructionDate | date:'yyyy'}}</i>
            </span>
            <span *ngIf="!hasConstructionDate()">
                <i>unbekannt</i>
            </span>
        </p>
        <div *ngIf="cardType == 'overview'">
            <div style="margin: 2em;">
                <p>
                    <mat-form-field style="width: 15em;">
                        <mat-label>Empfohlenes Sanierungsjahr</mat-label>
                        <input matInput min="{{ currentYear }}" max="9999" type="number"
                            [(ngModel)]="playdevice.properties.recommendedYearOfRenovation"
                            placeholder="Empfohlenes Sanierungsjahr...">
                    </mat-form-field>
                </p>
                <form class="choose_renovation_type_form">
                    <mat-form-field appearance="fill" style="width: 15em;">
                        <mat-label>Sanierungsart</mat-label>
                        <mat-select [formControl]="renovationTypeControl" required>
                            <mat-option value="0"></mat-option>
                            <mat-option value="1">Totalsanierung</mat-option>
                            <mat-option value="2">Teilsanierung</mat-option>
                        </mat-select>
                    </mat-form-field>
                </form>
                <p>
                    <mat-form-field style="width: 20em;">
                        <mat-label>Kommentar zum empf. Sanierungsjahr</mat-label>
                        <textarea matInput maxlength="255"
                            [name]="'comment_recommended_year_of_renovation_' + playdevice.properties.fid"
                            [(ngModel)]="playdevice.properties.commentRecommendedYearOfRenovation"
                            placeholder="Kommentar zum empf. Sanierungsjahr..."></textarea>
                    </mat-form-field>
                </p>
            </div>
        </div>
        <p style="margin-bottom: 2em;">
            <span *ngIf="cardType == 'defect' && playdevice.properties.hasOpenDefects"
                style="color:orange; border: solid; padding:0.5em;margin-right: 1em;">
                <b>Hat offene Mängel</b>
            </span>
            <span *ngIf="cardType != 'defect' && !playdevice.properties.recommendedYearOfRenovation"
                class="year_of_renovation_green">
                <b>Keine Sanierung geplant</b>
            </span>
            <span *ngIf="cardType != 'defect' && playdevice.properties.recommendedYearOfRenovation"
                [class.year_of_renovation_red]="(playdevice.properties.recommendedYearOfRenovation - currentYear) <= 1"
                [class.year_of_renovation_orange]="(playdevice.properties.recommendedYearOfRenovation - currentYear) > 1">
                <b>Sanierung ausstehend</b>
            </span>
        </p>
    </mat-card-content>
    <div *ngIf="cardType == 'defect'">
        <div *ngFor="let defect of playdevice.properties.defects">
            <mat-divider></mat-divider>
            <div style="padding: 1em;">
                <span>{{defect.defectDescription}}</span>
                <button mat-button [routerLink]="['/defect', playdevice.properties.fid, defect.tid]"
                    style="background-color: rgb(42,127,103); color: white;margin-left: 1em;">
                    ÖFFNEN
                </button>
            </div>
        </div>
    </div>
    <mat-divider *ngIf="!playdevice.properties.notToBeChecked"></mat-divider>
    <mat-card-actions style="margin: 0.5em;">
        <button *ngIf="cardType == 'inspection' && !playdevice.properties.notToBeChecked" mat-button
            [routerLink]="['/deviceattributes', 'playdevice', playdevice.properties.fid]"
            style="background-color: rgb(42,127,103); color: white;margin-top: 1em;">
            ÖFFNEN
        </button>
        <button *ngIf="cardType == 'defect'" mat-button [routerLink]="['/defect', playdevice.properties.fid, 0]"
            style="background-color: rgb(42,127,103); color: white;margin-top: 1em;">
            NEUER MANGEL
        </button>
        <button *ngIf="cardType == 'overview'" mat-button (click)="savePlayground()"
            style="background-color: rgb(42,127,103); color: white;margin-top: 1em;">
            SPEICHERN
        </button>
    </mat-card-actions>
</mat-card>